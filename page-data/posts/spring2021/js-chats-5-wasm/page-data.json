{
    "componentChunkName": "component---src-components-post-post-template-js",
    "path": "/posts/spring2021/js-chats-5-wasm/",
    "result": {"data":{"markdownRemark":{"html":"<p>We usually associate the browser with the language JavaScript. The browser,\nsuch as Google Chrome, takes the JS code and then executes its instructions\nsuch as performing calculations or manipulating elements of the DOM. For\nChrome, the \"engine\" that executes JavaScript is called <strong>V8</strong>. But V8 is not\njust a JavaScript engine! It can also run another language called\n<strong>WebAssembly</strong>.</p>\n<p>Side note: historically, JavaScript was not always the main language of the\nweb! Java used to be the hot new language to be run from browsers as applets.\nJavaScript was named after Java and ride off the hype as a scripting\nalternative. Check out <a href=\"https://www.vice.com/en/article/8q8n3k/a-brief-history-of-the-java-applet\">this\narticle</a>\nfor more.</p>\n<p>Disassembled WebAssembly looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"wasm\"><pre class=\"language-wasm\"><code class=\"language-wasm\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">func</span> <span class=\"token variable\">$dot</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">param</span> <span class=\"token keyword\">i32</span> <span class=\"token keyword\">i32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">result</span> <span class=\"token keyword\">f32</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">f32<span class=\"token punctuation\">.</span>add</span>\n    <span class=\"token punctuation\">(</span><span class=\"token keyword\">f32<span class=\"token punctuation\">.</span>add</span>\n      <span class=\"token punctuation\">(</span><span class=\"token keyword\">f32<span class=\"token punctuation\">.</span>mul</span>\n        <span class=\"token punctuation\">(</span><span class=\"token keyword\">f32<span class=\"token punctuation\">.</span>load</span>\n          <span class=\"token punctuation\">(</span><span class=\"token keyword\">local</span>.get <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">(</span><span class=\"token keyword\">f32<span class=\"token punctuation\">.</span>load</span>\n          <span class=\"token punctuation\">(</span><span class=\"token keyword\">local</span>.get <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">(</span><span class=\"token keyword\">f32<span class=\"token punctuation\">.</span>mul</span>\n        <span class=\"token punctuation\">(</span><span class=\"token keyword\">f32<span class=\"token punctuation\">.</span>load</span> <span class=\"token keyword\">offset<span class=\"token operator\">=</span></span><span class=\"token number\">4</span>\n          <span class=\"token punctuation\">(</span><span class=\"token keyword\">local</span>.get <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">(</span><span class=\"token keyword\">f32<span class=\"token punctuation\">.</span>load</span> <span class=\"token keyword\">offset<span class=\"token operator\">=</span></span><span class=\"token number\">4</span>\n          <span class=\"token punctuation\">(</span><span class=\"token keyword\">local</span>.get <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">(</span><span class=\"token keyword\">f32<span class=\"token punctuation\">.</span>mul</span>\n      <span class=\"token punctuation\">(</span><span class=\"token keyword\">f32<span class=\"token punctuation\">.</span>load</span> <span class=\"token keyword\">offset<span class=\"token operator\">=</span></span><span class=\"token number\">8</span>\n        <span class=\"token punctuation\">(</span><span class=\"token keyword\">local</span>.get <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">(</span><span class=\"token keyword\">f32<span class=\"token punctuation\">.</span>load</span> <span class=\"token keyword\">offset<span class=\"token operator\">=</span></span><span class=\"token number\">8</span>\n        <span class=\"token punctuation\">(</span><span class=\"token keyword\">local</span>.get <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Similar to x86 assembly code, you will pretty much never write WebAssembly code\nby hand. Instead, you use a higher level language such as C, C++, Rust, etc.,\nand compile it into WebAssembly. AssemblyScript is a variant of TypeScript\ndesigned to compile into WebAssembly. You can't directly compile JavaScript\ninto WebAssembly since there aren't any types. However, you can call JavaScript\ncode from WebAssembly so they work well together. Anything JavaScript can do,\nWebAssembly can also do but you don't have to use just one or the other.</p>\n<h2 id=\"why-would-you-use-webassembly\" style=\"position:relative;\"><a href=\"#why-would-you-use-webassembly\" aria-label=\"why would you use webassembly permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Why would you use WebAssembly?</h2>\n<p>JavaScript is usually just fine, and many engineers have worked on the V8\nJavaScript engine so that it runs pretty fast. Even though JavaScript is\ntraditionally an interpreted language, V8 uses \"just in time\" compilation to\nturn the JavaScript code into fast machine code (x86, ARM, etc.) dependent on\nthe physical machine it is being run on. However because JavaScript is\ndynamically typed, there are limitations to its performance. The following\nexplanations are summarized from <a href=\"https://surma.dev/things/js-to-asc/index.html\">this excellent\narticle</a> by Surma.</p>\n<p>V8 needs to warm up before generating the fast low-level machine code. In order\nto start executing as fast as possible, V8 starts by running the JavaScript\ncode through the interpreter. Then it observes executing code for the object\nshapes (which can be thought of as types). Once enough data is collected, then\nit can begin the just-in-time compilation for faster execution. WebAssembly\ndoes not need this initial warmup time.</p>\n<p>In addition because types are dynamic in JavaScript, it's possible that the\ncompiled machine code has the incorrect type later on. For example, maybe a\nfunction took in an integer at first but later on an object was passed into the\nsame function. In this case, the compiled machine code cannot be used anymore\nand the JavaScript execution will fall back to the slower interpreter.</p>\n<p>Since WebAssembly is typed, it does not have these problems so you can get more\nreliable performance. In addition, WebAssembly has a more compact binary format\nthan JavaScript (which is in text format) and is easier to parse since the\nrules are not as complex.</p>\n<p>For performance intensive applications such as 3D games, VR/AR, image/video\nediting, or computer vision, using WebAssembly can have a lot of benefits. For\nexample,\n<a href=\"https://www.figma.com/blog/webassembly-cut-figmas-load-time-by-3x/\">Figma</a>\nused WebAssembly to cut their load time by 3x all the way back in 2017 when\nWebAssembly was just getting started.</p>\n<h2 id=\"principles-of-webassembly-speed-safety-interoperability\" style=\"position:relative;\"><a href=\"#principles-of-webassembly-speed-safety-interoperability\" aria-label=\"principles of webassembly speed safety interoperability permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Principles of WebAssembly: Speed, Safety, Interoperability</h2>\n<p>If we want performance, why not just let browsers run C? C is a low-level\nlanguage. It's close to machine code and used in applications where performance\nis very important. While it is possible, another major principle of WebAssembly\nis <strong>safety</strong>. C has a lot of undefined behaviors and gives you a lot of power\nto manipulate memory in a machine. WebAssembly has no undefined behaviors and\nprevents you from accessing memory outside of your current tab. Another\nprinciple of WebAssembly is <strong>interoperability</strong>. C has many OS and CPU\nspecific APIs that are not desirable for a browser. The execution of C also\ndepends on the compiler that you use among other factors. An important part of\nWebAssembly is that it can be run exactly the same way on any browser, any OS,\nand any hardware.</p>\n<h2 id=\"demo\" style=\"position:relative;\"><a href=\"#demo\" aria-label=\"demo permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Demo</h2>\n<p>As a demo today, we will be writing a program today to compute primes. The\nprogram will be written in C, but we will compile it to WebAssembly to allow it\nto be run across different browsers.</p>\n<p>Our demo code is available on GitHub at\n<a href=\"https://github.com/uclaacm/js-chats-s21/tree/main/webassembly\">https://github.com/uclaacm/js-chats-s21/tree/main/webassembly</a>.</p>\n<h3 id=\"dipping-our-feet-into-the-water\" style=\"position:relative;\"><a href=\"#dipping-our-feet-into-the-water\" aria-label=\"dipping our feet into the water permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Dipping our feet into the water</h3>\n<p>Here's the C code for finding all primes less than a particular number. We will\nname this file <code class=\"language-text\">primes.c</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdbool.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdlib.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;string.h></span></span>\n\n<span class=\"token comment\">// FindAllPrimes sets a[p] to true for every prime p &lt; max,</span>\n<span class=\"token comment\">// and set all other a[i] to false.</span>\n<span class=\"token comment\">// a is expected to have length max.</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">FindAllPrimes</span><span class=\"token punctuation\">(</span>bool<span class=\"token operator\">*</span> a<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> max<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 0 and 1 are not primes.</span>\n  a<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span>\n  a<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Sieve of Eratosthenes: first consider all numbers prime, but reverse</span>\n  <span class=\"token comment\">// that decision once we find a way of getting that number through</span>\n  <span class=\"token comment\">// multiplication.</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> max<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    a<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> max<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">*</span> i <span class=\"token operator\">></span> max<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> j <span class=\"token operator\">=</span> i <span class=\"token operator\">*</span> i<span class=\"token punctuation\">;</span> j <span class=\"token operator\">&lt;</span> max<span class=\"token punctuation\">;</span> j <span class=\"token operator\">+=</span> i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        a<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// PrintPrimes prints all primes up to (but not including) max.</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">PrintPrimes</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> max<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  bool<span class=\"token operator\">*</span> a <span class=\"token operator\">=</span> <span class=\"token function\">malloc</span><span class=\"token punctuation\">(</span>max <span class=\"token operator\">*</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>bool<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">FindAllPrimes</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span> max<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> max<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Found prime: %d\\n\"</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">PrintPrimes</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Since the <code class=\"language-text\">main</code> function contains <code class=\"language-text\">PrintPrimes(100)</code>, compiling and running\nthis file using a C compiler will print out all primes between 2 and 100.</p>\n<p>Now we will use a tool called <a href=\"https://emscripten.org/\">Emscripten</a> to compile\nthis C file into WebAssembly. Emscripten actually supports multiple use cases:\nrunning your code in Node.js versus in a web browser. We will set the \"output\"\nfile name to be an HTML file, which actually supports both Node.js and the\nbrowser.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">❯ docker run           <span class=\"token punctuation\">\\</span>\n  --rm                 <span class=\"token punctuation\">\\</span>\n  -v <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">pwd</span><span class=\"token variable\">)</span></span>:/src       <span class=\"token punctuation\">\\</span>\n  -u <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">id</span> -u<span class=\"token variable\">)</span></span><span class=\"token builtin class-name\">:</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">id</span> -g<span class=\"token variable\">)</span></span> <span class=\"token punctuation\">\\</span>\n  emscripten/emsdk     <span class=\"token punctuation\">\\</span>\n  emcc primes.c -o primes.html</code></pre></div>\n<p>After running this command, you should see three new files:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">❯ ls\nprimes.c  primes.html  primes.js  primes.wasm</code></pre></div>\n<p>The <code class=\"language-text\">wasm</code> file contains the actual compiled functionality. Unfortunately, we\ncan't run the <code class=\"language-text\">wasm</code> file directly; instead, we also need the <code class=\"language-text\">js</code> file\ncontains some \"glue code\" that tells the JavaScript engine <em>how</em> to run the\n<code class=\"language-text\">wasm</code> file. Finally, the <code class=\"language-text\">html</code> file wraps the <code class=\"language-text\">primes.js</code> file to allow\nrunning the program in the browser.</p>\n<p>We can first try to run <code class=\"language-text\">primes.js</code> with Node.js.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">❯ node primes.js\nFound prime: 2\nFound prime: 3\nFound prime: 5\n...\nFound prime: 97</code></pre></div>\n<p>Seems to work!</p>\n<p>Running the program in the browser proves a bit trickier. Merely opening the\nHTML file doesn't work, as it's stuck at the \"preparing\" stage forever.\nInstead, we need to launch an HTTP server in the current directory<sup><a href=\"#footnote-1\">[1]</a></sup> (we use\n<a href=\"https://www.npmjs.com/package/http-serve\">http-serve</a> for this purpose):</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">❯ http-serve .\nStarting up http-serve for .\nAvailable on:\n  http://127.0.0.1:8080\n  http://192.168.1.133:8080\nHit CTRL-C to stop the server</code></pre></div>\n<p>Then, visiting <a href=\"http://127.0.0.1:8080/primes.html\">http://127.0.0.1:8080/primes.html</a> works like a charm!</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/99c708ce0dfe885629359efdd0c5ff4e/e40ed/wasm-chrome.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 57.668711656441715%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABvklEQVQoz62SvW4aQRSFRxQxIJGtMBJRFGEn/FQgQLT2EyQuqZB4El6CkpKWhpIuSojSpEsRyYqCsjvsj3d32F12FxZ2TjQjxXJsN5ZzpU9Xo3PvmTtXQ/S1CX1tcl03YNs2TNOEbTtwnMdxXQaXuXBdFzeWCde5gapRTjUN2vVPTnTnF1+tf4DqKvS1Ds/zEIYhDocDjsfjPyRJgjiOEYURgiCCbWhgjg628fB7teKGYYB8v/6GL1+X/NPnj1gul9jv9xAhDHe7nTyLLMyCIABjLvxNCGYH8H0f3sYXF3AxiGVanPAUSFMuJ0jTFHEUS8PpdIpyuYx6vY5qtYparYZKpYLFYiH1JNnfTi4u55zLlRHcC1EgYjwegxDygNlsJvX0mN5vBWMMRBiIZ/0liiIpTiYTZLNZlEolFItFiaIomM/nUhd1d/uEj2VZIFfvP+Dy4hLtdhvdbhedTkfmZrOJRqPxgFarJfW79Ho9uZLRaATy5tVrnLw4efR5T2UwGIDUzt9Beak8yyiTycjc7/dB3p6d47R4ysW+8vk8crnckykUCtJwOByCUEq5pmmglD4bVVVvvw3Hf4jtdos/qGyb6l9ZOxkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Prime number finding function running in Google Chrome\"\n        title=\"Prime number finding function running in Google Chrome\"\n        src=\"/static/99c708ce0dfe885629359efdd0c5ff4e/a6d36/wasm-chrome.png\"\n        srcset=\"/static/99c708ce0dfe885629359efdd0c5ff4e/222b7/wasm-chrome.png 163w,\n/static/99c708ce0dfe885629359efdd0c5ff4e/ff46a/wasm-chrome.png 325w,\n/static/99c708ce0dfe885629359efdd0c5ff4e/a6d36/wasm-chrome.png 650w,\n/static/99c708ce0dfe885629359efdd0c5ff4e/e548f/wasm-chrome.png 975w,\n/static/99c708ce0dfe885629359efdd0c5ff4e/3c492/wasm-chrome.png 1300w,\n/static/99c708ce0dfe885629359efdd0c5ff4e/e40ed/wasm-chrome.png 1378w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a8aec9dcbfe79b1c502d40189f32743c/f793b/wasm-firefox.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.282208588957054%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABxklEQVQoz62QzW7aQBSFZ4sAARuEWCAkDGIHK1YINkioQYgFD8AL8HJ9ArJoozRdVKWxUrWLVsThr/aMx9gee8Yzt7KLo/5k06ZH+nSvjs5c3bnItE6rr1vr02aHbzc7U98eLd2yLN22bZ0QklRK6SOO4/zozz6JcxjrxDzcYdN8h47443Fj3MHD9jPs9w9wPBzA87yEMAxBKQWp4l4IAa7rgeOcwHVdwIQAxRjs3ZfYU+gbvb1ff3gLb26uo9XlSr5fryUAJARBIF3XTfA8T1JK5WG/l7bjSnpyJbXtxAvCUHp+AL7v+yhgwjgvINNNGGNJXSwWkMlkoFKpJORyORiNRiBlBJEQybZRFIEQXMV9EAQMAag/BqaaTCaAEPqFdrsNTyi9C0OEEMNxHLBtW2KMIcY0zeR+y+USGo0GdLtd6HQ60Gw2YT6fAyEE0uwZFXuWZTHU6/WM+IGmabJQKECxWHykVCo9yc+Zc07F52i1WgxpmmbUarXYlL9/7y9QcS2XywzV63WjWq1CPp9/9sBsNsvQbDa7n06nMB6PxWAwiIbD4T/R7/fVi4sLD0kpLfiPQpzzl0KIG875K87562dwxTm//A5D55y+qLpyJAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Prime number finding function running in Mozilla Firefox\"\n        title=\"Prime number finding function running in Mozilla Firefox\"\n        src=\"/static/a8aec9dcbfe79b1c502d40189f32743c/a6d36/wasm-firefox.png\"\n        srcset=\"/static/a8aec9dcbfe79b1c502d40189f32743c/222b7/wasm-firefox.png 163w,\n/static/a8aec9dcbfe79b1c502d40189f32743c/ff46a/wasm-firefox.png 325w,\n/static/a8aec9dcbfe79b1c502d40189f32743c/a6d36/wasm-firefox.png 650w,\n/static/a8aec9dcbfe79b1c502d40189f32743c/e548f/wasm-firefox.png 975w,\n/static/a8aec9dcbfe79b1c502d40189f32743c/3c492/wasm-firefox.png 1300w,\n/static/a8aec9dcbfe79b1c502d40189f32743c/f793b/wasm-firefox.png 1404w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><sup id=\"footnote-1\">[1]</sup> See the Emscripten <a href=\"https://emscripten.org/docs/getting_started/FAQ.html#how-do-i-run-a-local-webserver-for-testing-why-does-my-program-stall-in-downloading-or-preparing\">“Why does my program stall\nin ‘Downloading…’ or ‘Preparing…’?”</a>\nFAQ entry.</p>\n<h3 id=\"printprimes-using-ccall-and-cwrap-helpers\" style=\"position:relative;\"><a href=\"#printprimes-using-ccall-and-cwrap-helpers\" aria-label=\"printprimes using ccall and cwrap helpers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PrintPrimes: Using ccall and cwrap helpers</h3>\n<p>So… that was pretty cool, but how can it be useful? All we can do right now is\nfinding primes less than 100. Ideally, we would have a way of integrating the\ncompiled WebAssembly code into an existing JavaScript application, so that we\ncan find primes of any size.</p>\n<p>More concretely, by default Emscripten automatically creates a <code class=\"language-text\">primes.js</code> file\nthat runs the <code class=\"language-text\">main</code> function. But we want to have a way of running the\nPrintPrimes and FindAllPrimes function ourselves.</p>\n<p>The first thing we need to do is to tell Emscripten that we are interested in\nrunning the functions ourselves.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">❯ docker run                                                   <span class=\"token punctuation\">\\</span>\n  --rm                                                         <span class=\"token punctuation\">\\</span>\n  -v <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">pwd</span><span class=\"token variable\">)</span></span>:/src                                               <span class=\"token punctuation\">\\</span>\n  -u <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">id</span> -u<span class=\"token variable\">)</span></span><span class=\"token builtin class-name\">:</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">id</span> -g<span class=\"token variable\">)</span></span>                                         <span class=\"token punctuation\">\\</span>\n  emscripten/emsdk                                             <span class=\"token punctuation\">\\</span>\n  emcc                                                         <span class=\"token punctuation\">\\</span>\n    -s MODULARIZE                                              <span class=\"token punctuation\">\\</span>\n    -s <span class=\"token assign-left variable\">EXPORTED_FUNCTIONS</span><span class=\"token operator\">=</span><span class=\"token string\">'[\"_FindAllPrimes\", \"_PrintPrimes\"]'</span> <span class=\"token punctuation\">\\</span>\n    -s <span class=\"token assign-left variable\">EXPORTED_RUNTIME_METHODS</span><span class=\"token operator\">=</span><span class=\"token string\">'[\"ccall\", \"cwrap\"]'</span>           <span class=\"token punctuation\">\\</span>\n    primes.c -o primes.js</code></pre></div>\n<p>Whoa! What's going on here? It turns out that to achieve what we want, we need\nto pass three different flags through <code class=\"language-text\">-s</code>:</p>\n<ol>\n<li><code class=\"language-text\">MODULARIZE</code>, which creates a Node.js module file that we can easily reuse.</li>\n<li><code class=\"language-text\">EXPORTED_FUNCTIONS</code>, which defines which C functions we are interested in\ncalling. Note, we have to include a leading underscore <code class=\"language-text\">_</code>.</li>\n<li><code class=\"language-text\">EXPORTED_RUNTIME_METHODS</code>, which asks Emscripten to include the <code class=\"language-text\">ccall()</code>\nand <code class=\"language-text\">cwrap()</code> helper functions.</li>\n</ol>\n<p>Finally, we also need to change the extension of <code class=\"language-text\">primes.html</code> to <code class=\"language-text\">primes.js</code>.</p>\n<hr>\n<p>After this is done, we can now write our own JavaScript code. We will call this\nfile <code class=\"language-text\">primes-cwrap.js</code>. Here it is:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token string\">'use strict'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> initializeWasm <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./primes.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> Module <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">initializeWasm</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> printPrimes <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">cwrap</span><span class=\"token punctuation\">(</span><span class=\"token string\">'PrintPrimes'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'void'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'number'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">printPrimes</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>First, the <code class=\"language-text\">primes.js</code> file now exports an \"initializer\" function that returns\na promise, so we need to <code class=\"language-text\">await</code> it before doing anything further.</p>\n<p>Then, we need to call a function called <code class=\"language-text\">cwrap</code>. It helps do some type\nconversion, like converting JavaScript string to an array of ASCII/UTF-8 bytes\nand vice versa.</p>\n<p>Finally, we can now call the <code class=\"language-text\">printPrimes</code> function – as if it was written in\nJavaScript!</p>\n<p>Running the <code class=\"language-text\">primes-cwrap.js</code> file in Node.js produces the expected results:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">❯ node primes-cwrap.js\nFound prime: 2\nFound prime: 3\nFound prime: 5\n...\nFound prime: 199</code></pre></div>\n<hr>\n<p>There is also another helper Emscripten provides called <code class=\"language-text\">ccall</code>. Unlike\n<code class=\"language-text\">cwrap</code>, it allows you to call C functions in a single line:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token string\">'use strict'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> initializeWasm <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./primes.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> Module <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">initializeWasm</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  Module<span class=\"token punctuation\">.</span><span class=\"token function\">ccall</span><span class=\"token punctuation\">(</span><span class=\"token string\">'PrintPrimes'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'void'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'number'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">200</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>We personally found <code class=\"language-text\">ccall</code> to be less readable than <code class=\"language-text\">cwrap</code> though.</p>\n<h3 id=\"findallprimes-calling-c-functions-directly\" style=\"position:relative;\"><a href=\"#findallprimes-calling-c-functions-directly\" aria-label=\"findallprimes calling c functions directly permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>FindAllPrimes: Calling C functions directly</h3>\n<p>We see that <code class=\"language-text\">ccall</code> and <code class=\"language-text\">cwrap</code> have given us more control over running\ncompiled WebAssembly code, but it still feels awkward to use in JavaScript. In\nparticular, it prints out the primes directly without letting us use the\nnumbers. What we really want to do is have a JavaScript function\n<code class=\"language-text\">findAllPrimes</code> that takes <code class=\"language-text\">max</code> and returns an array of primes.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">findAllPrimes</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">max</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> primes <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// ...</span>\n  <span class=\"token keyword\">return</span> primes<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Unfortunately, calling FindAllPrimes proves to be a bit tricky. The function\nsignature of <code class=\"language-text\">FindAllPrimes</code> is</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">void</span> <span class=\"token function\">FindAllPrimes</span><span class=\"token punctuation\">(</span>bool<span class=\"token operator\">*</span> a<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> max<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The first argument is a <em>pointer</em> to a boolean, which is a <em>memory address</em> –\nand sadly, <code class=\"language-text\">ccall</code> and <code class=\"language-text\">cwrap</code> don't support pointer types.</p>\n<p>To fix this, we need two ingredients:</p>\n<h4 id=\"direct-calls\" style=\"position:relative;\"><a href=\"#direct-calls\" aria-label=\"direct calls permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Direct calls</h4>\n<p>It turns out that Emscripten also allows <strong>direct calls</strong> to the WebAssembly\nfunction. So for the previous example, we could have really done:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> Module <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">initializeWasm</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nModule<span class=\"token punctuation\">.</span><span class=\"token function\">_PrintPrimes</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>This gives us another way of calling C functions, bypassing <code class=\"language-text\">ccall</code> and <code class=\"language-text\">cwrap</code>\n(which don't support pointers). But we still need a second ingredient of\nactually acquiring a memory address.</p>\n<h4 id=\"allocating-memory\" style=\"position:relative;\"><a href=\"#allocating-memory\" aria-label=\"allocating memory permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Allocating memory</h4>\n<p>Where we are stuck now is: how on earth can we create a valid pointer value to\npass to <code class=\"language-text\">FindAllPrimes</code>? We can't just make some number up, as it could already\nbe occupied by other parts of the program.</p>\n<p>The solution here is to call into the <code class=\"language-text\">malloc()</code> and <code class=\"language-text\">free()</code> C functions. As a\nrefresher, in C, the <code class=\"language-text\">malloc()</code> functions take a number of bytes and returns\nthe address to a newly allocated block of memory. When we are done with that\nblock of memory, we can allow C to use it for other purposes by calling\n<code class=\"language-text\">free()</code>.</p>\n<p>With this knowledge, we can then build a new <code class=\"language-text\">primes.js</code> file that exposes\n<code class=\"language-text\">malloc()</code> and <code class=\"language-text\">free()</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">❯ docker run                                                                       <span class=\"token punctuation\">\\</span>\n  --rm                                                                             <span class=\"token punctuation\">\\</span>\n  -v <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">pwd</span><span class=\"token variable\">)</span></span>:/src                                                                   <span class=\"token punctuation\">\\</span>\n  -u <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">id</span> -u<span class=\"token variable\">)</span></span><span class=\"token builtin class-name\">:</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">id</span> -g<span class=\"token variable\">)</span></span>                                                             <span class=\"token punctuation\">\\</span>\n  emscripten/emsdk                                                                 <span class=\"token punctuation\">\\</span>\n  emcc                                                                             <span class=\"token punctuation\">\\</span>\n    -s MODULARIZE                                                                  <span class=\"token punctuation\">\\</span>\n    -s <span class=\"token assign-left variable\">EXPORTED_FUNCTIONS</span><span class=\"token operator\">=</span><span class=\"token string\">'[\"_FindAllPrimes\", \"_PrintPrimes\", \"_malloc\", \"_free\"]'</span> <span class=\"token punctuation\">\\</span>\n    -s <span class=\"token assign-left variable\">EXPORTED_RUNTIME_METHODS</span><span class=\"token operator\">=</span><span class=\"token string\">'[\"ccall\", \"cwrap\"]'</span>                               <span class=\"token punctuation\">\\</span>\n    primes.c -o primes.js</code></pre></div>\n<p>Then, we can take advantage of <code class=\"language-text\">malloc()</code> and <code class=\"language-text\">free()</code> to write\n<code class=\"language-text\">primes-direct.js</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token string\">'use strict'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> initializeWasm <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./primes.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">findAllPrimes</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">max</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> Module <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">initializeWasm</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Allocate an array of `max` booleans.</span>\n  <span class=\"token keyword\">const</span> ptr <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">_malloc</span><span class=\"token punctuation\">(</span>max<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Call FindAllPrimes.</span>\n  Module<span class=\"token punctuation\">.</span><span class=\"token function\">_FindAllPrimes</span><span class=\"token punctuation\">(</span>ptr<span class=\"token punctuation\">,</span> max<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// For each i, check if the boolean is false (0) or true (anything else).</span>\n  <span class=\"token comment\">// If it's not 0, then add i to the primes array.</span>\n  <span class=\"token keyword\">const</span> primes <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> max<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Module<span class=\"token punctuation\">.</span><span class=\"token constant\">HEAP8</span><span class=\"token punctuation\">[</span>ptr <span class=\"token operator\">+</span> i<span class=\"token punctuation\">]</span> <span class=\"token operator\">!==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      primes<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// We need to free the memory we allocated earlier before returning.</span>\n  Module<span class=\"token punctuation\">.</span><span class=\"token function\">_free</span><span class=\"token punctuation\">(</span>ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> primes<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span> <span class=\"token function\">findAllPrimes</span><span class=\"token punctuation\">(</span><span class=\"token number\">300</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>Stop and think. What could go wrong with this code?</p>\n<ul>\n<li>What if we call <code class=\"language-text\">findAllPrimes(0)</code>? or <code class=\"language-text\">findAllPrimes(-1)</code>? or\n<code class=\"language-text\">findAllPrimes({ key: 42 })</code>?</li>\n<li>What if <code class=\"language-text\">max</code> is very large? What would <code class=\"language-text\">Module._malloc</code> return?</li>\n<li>What if <code class=\"language-text\">primes.push</code> somehow throws an exception? What happens to <code class=\"language-text\">ptr</code>?</li>\n<li>What if each C boolean actually requires two bytes?</li>\n<li>What if we end up calling <code class=\"language-text\">initializeWasm</code> many, many times?</li>\n</ul>\n</blockquote>\n<p>We tried to fix some of these problems and make our code more robust, in\n<a href=\"https://github.com/uclaacm/js-chats-s21/blob/main/webassembly/primes-direct-robust.js\">primes-direct-robust.js</a>,\nwhich unfortunately complicates the code quite a bit.</p>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>Our demo today exposes some of the problems with using WebAssembly. If you are\ncalling into WebAssembly functions from JavaScript, many times you would be\nforced to essentially write code in that other language (C, C++, or anything\nelse) but in JavaScript, and to deal with the same problems as the original\nlanguage (e.g., memory allocation and cleanup). We think it is good practice to\ndo <strong>as much as possible</strong> in the source/compiled language, and to <strong>minimize\nthe interface</strong> between JavaScript and WebAssembly.</p>","frontmatter":{"date":"2021-05-04T00:00:00.000Z","title":"Introduction to WebAssembly","subtitle":"JavaScript Chats Hack Session 5, Spring 2021","author":null}}},"pageContext":{"slug":"/posts/spring2021/js-chats-5-wasm/"}},
    "staticQueryHashes": ["1274017682"]}