{"componentChunkName":"component---src-components-post-post-template-js","path":"/posts/spring2021/js-chats-2/","result":{"data":{"markdownRemark":{"html":"<p>In the previous <a href=\"/posts/fall2019/js-chats-4\">JS Chats on optimization</a>, we took\na peek at the Chrome DevTools and how we can use the Performance tools to\nprofile our web application loading time. Since both Node.js and Chromium both\nrely on the <a href=\"https://v8.dev/\">V8 engine</a> and adhere to the <a href=\"https://chromedevtools.github.io/devtools-protocol/\">Chrome DevTools\nprotocol</a>, the DevTools in\nChrome can actually be a debugger and a profiler for Node.js as well! Let's see\nhow we can use it. </p>\n<p>Here, we built a very simple sever program, with one API endpoint to get some\ncryptocurrency prices.  </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/coin-prices'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> listOfCoins <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'dogecoin'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'bitcoin'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'ethereum'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'polkadot'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'litecoin'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'cardano'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'bitcoin-cash'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'stellar'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'chainlink'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'binancecoin'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> prices <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> coinId <span class=\"token keyword\">of</span> listOfCoins<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        prices<span class=\"token punctuation\">[</span>coinId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getCoinPrice</span><span class=\"token punctuation\">(</span>coinId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>prices<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The full server program can be found here:</p>\n<blockquote>\n<p><a href=\"https://github.com/uclaacm/js-chats-s21/tree/main/node-profile\">https://github.com/uclaacm/js-chats-s21/tree/main/node-profile</a></p>\n</blockquote>\n<p>The endpoint uses a list of coin IDs, queries their prices against an external\nAPI <code class=\"language-text\">getCoinPrice</code>, and return them as a JSON object. For those who has worked\nwith async programming in JavaScript before, you might have already noticed the\nbad performance pattern. If not, don't worry. We will show where the bad spot\nis and how to optimize it. Let's try to profile this.</p>\n<p>To allow for profiling, we invoke the server program with the <code class=\"language-text\">--inspect</code> flag.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">node --inspect index.js</code></pre></div>\n<p>The terminal outputs the following</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Debugger listening on ws://127.0.0.1:9229/9b78b923-925f-462c-8dca-345b3b6f9f38\nFor help, see: https://nodejs.org/en/docs/inspector</code></pre></div>\n<p>This means the profiler and debugger has been invoked. Now, we head to Chrome\nand open DevTools (right click anywhere and click inspect). On the top left corner,\na Node.js icon is going to pop up. </p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 650px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/39eab2f33c5d2c3e4f85cf6342c38d1c/f7616/devtool-node.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.239263803680984%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB8ElEQVQoz12SSY/TQBCF8/9viD/AiStCXLgjIRgxo5lxyHicON4dr+2t7cRL8lHJcEC0VOruUvWrV+/1KklT0iTBPyTkj/esP70j+PKBvijwPBffdXD2O1SZ07YtfhDg+z5hGKJ1TxRFBLdcgFKKVRzHBFLgRTG58cj95/d4Xz+SxIofhsf3B4tvv0wMO6WsmlsT27ZxXVcA9Q3QcRz2e5s8z1kty8I0T3S6Q/cDi2qYpbDpOo7ThQtwlpDjbf93Xc7/Z2A1zzNVqCi2BaOuKf3fVNmBIOoZh55y/0R72NMlDm3iUsd7MuserTKy7Mjzc0nTjDTxjtLdsBpHuQir4jWnsFKqNEF5BdFTRnOopOcJlhPnWfbzdDtfpl7yCxdhPfTzG7XzKHH8C1g3JEZMtskZ2prcehRWkejYY6xrzNdW2JxEr15M6QmjAWvbsN3WxFIThlo01RhGxWoaT8JoQ+VtUa5JHb5SBSZDlaDLhMS28J9/yqiOPNZiQMvdXYZp1kRBzTTNLMuFcVzEpElMEQ3naaSSb6LsDC1OXUHbqyZZg71T8lDhOvVNsyDQ4nIjwJ24PpOmR3a7Wtg2Aji/mXJdQzeQmwV9rsQki+xQ8yIsHLcjCHsZqWOzqYRZRVkMdEVC/PJAIwSu46/XSr5Oyx8nv6FtqDHh4AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"button to open Node.js debugger in Chrome DevTools\"\n        title=\"button to open Node.js debugger in Chrome DevTools\"\n        src=\"/static/39eab2f33c5d2c3e4f85cf6342c38d1c/a6d36/devtool-node.png\"\n        srcset=\"/static/39eab2f33c5d2c3e4f85cf6342c38d1c/222b7/devtool-node.png 163w,\n/static/39eab2f33c5d2c3e4f85cf6342c38d1c/ff46a/devtool-node.png 325w,\n/static/39eab2f33c5d2c3e4f85cf6342c38d1c/a6d36/devtool-node.png 650w,\n/static/39eab2f33c5d2c3e4f85cf6342c38d1c/f7616/devtool-node.png 766w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>After we click on it, the Node.js profiler will pop up. </p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 650px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/dd7901a644a9ce1f64af6b2157be17ef/7be33/node-chrome-profiler.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 111.65644171779141%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAABYlAAAWJQFJUiTwAAADVUlEQVQ4y5WUW08TQRTHIeqLz65fwO/gN9CEB1+ITzXRh4qJ0eiLDyDGxISYqERDJNFgjYiXhMRrtKSgBfECRbRo0JIY2i7bdsv2spd2u8VOt3/PTi9UChhP88+Z3Z359Zw5Z6atjezbmaO7R56c2/vq3eSej/4p4dP0tPDu7VthfnZWuDU4KPRfuSL0XbokPBweFt5PTgq+16+FibExYdzrFabevNkzNzOz1z8+vrutbomvs1eTq0tQ0qu6lsmYmVTKzKbTXHFJMpd//TKj4bC5Eo2auqr+JZqj53QdkijeaAC/LYU9+TVAkjMVI5eHThNM04SqqrAsiz8Xi0X+XCgUUCqVuBhjMAyjArJoNDrSAMYT8pDzkr6Uqu7fqhuqa5BMJu+tp5xIcGC5XGaoGY1hV+zq2KaxbXN5PB5ks1k0zWM14HALkIw5aTiwupXKpfUxpdnZ2emkV5/MXQswFotxYCQSYW63G11dXZAkCS8jIzj51IXPsVkEPgXgOuJCR0cHgsEguru74XK5sLi4yIHxeHwdKIoiBw4MDLCe8z04e/osLg9cxnFfJ/Zf34cLYz04deIUei/0wn3cjf5r/Th46AAGPTexEFxoBVI0HOj3+1koFML8/Dzef/wAT2AIxx4ehi80Bq/Xy9Pt6+sDBcCzePT40eYpN+8hNpiYERFWlrGkhPAz8hPVwlb3r1acrYFURVavpqMK/aTMCgLLM3jx5Rmk7EqjA+pGf7A90ImgLscyuTQWxCCC4ldoplqHUEuR7MrmQFmWt0yZt4tdavRkq20ClGptk9UMphk5qJoGnbxuGFwF00IubyJPMnL0Xje4Txm/oVs2B8rNQHElNqT+BsKrFosqFuKJJEmGRmfYojNsWUUU6EwXi2vcm3SenTNuFBgKa3ZrhKvJJI9Q11SWzxn4P9tmDzVNY3R78Co2F+cfqqYsy+vAZC1CRUkx6q1KM3DjRbMBVnE6owVIx+Z2Lf6iU2lnUplPtNmd6Tzrfaazi891dmsqz1DhvdqsYg14twFUFOXBVjtUIKXowkkTPr/NTqbT6dEG0OfzHaEbZDQQCNybm5u736zFhc/3Q9+r+kHjjd+dNc7aiYmJYxxGIbeTc7SDtIu08z+1q7a2nQra/gd60Eu7RALWjgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Node.js Chrome debugger\"\n        title=\"Node.js Chrome debugger\"\n        src=\"/static/dd7901a644a9ce1f64af6b2157be17ef/a6d36/node-chrome-profiler.png\"\n        srcset=\"/static/dd7901a644a9ce1f64af6b2157be17ef/222b7/node-chrome-profiler.png 163w,\n/static/dd7901a644a9ce1f64af6b2157be17ef/ff46a/node-chrome-profiler.png 325w,\n/static/dd7901a644a9ce1f64af6b2157be17ef/a6d36/node-chrome-profiler.png 650w,\n/static/dd7901a644a9ce1f64af6b2157be17ef/e548f/node-chrome-profiler.png 975w,\n/static/dd7901a644a9ce1f64af6b2157be17ef/3c492/node-chrome-profiler.png 1300w,\n/static/dd7901a644a9ce1f64af6b2157be17ef/7be33/node-chrome-profiler.png 1558w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>The tabs are:</p>\n<ul>\n<li><strong>Connection</strong>: choosing which Node.js instance to connect to</li>\n<li><strong>Profiler</strong>: capture and inspect CPU profile for Node.js instance</li>\n<li><strong>Console</strong>: look at output from <code class=\"language-text\">console.log</code> from the Node.js instance </li>\n<li><strong>Sources</strong>: the debugger interface</li>\n<li><strong>Memory</strong>: capture memory snapshot </li>\n</ul>\n<p>We will focus on the Profiler tab. </p>\n<h2 id=\"profiling-nodejs\" style=\"position:relative;\"><a href=\"#profiling-nodejs\" aria-label=\"profiling nodejs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Profiling Node.js</h2>\n<p>We have one endpoint and let's take a look at its performance.\nThe steps we are going to take for profiling are:</p>\n<ol>\n<li>Start the profiling </li>\n<li>Send a request to our app</li>\n<li>End the profiling</li>\n</ol>\n<p>To start the profiling, we click the \"record\" button on the top left. </p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 650px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0dca8eb2530d423ec59efcea05001bb9/7be33/start-profile.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 111.65644171779141%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAABYlAAAWJQFJUiTwAAACx0lEQVQ4y+2UzU8TQRjGIcqFM8uf41+hB2OiMZ6MiZp48SQHDhg9aEg0ptjiIphgkNQQ0JaPVmib9mBPJJSiS1nb/d7tfpW2O+28zgzbYiJE8OLFSZ48O7Ozv33enZkdGCCtePnScCx6czS+nhhJJda4zfQmt55McoVslns5Ock9nZjgxsfGuJlYjEuvrnGflpa45MoKl1he5lKrqyOFXG50PZEYHug1cXv7iWQIIKuabeqmryqqb+iGb+q6XxVF//venl8RBF+sVHynXmeyLYuJzLFd2wZy79kxcDH6GmQBfM/AriGDW9eh1XDAMAxoNBpgWRZzXdfB8zxotVoQBAEECIHjOBhI29/fn+kDb92di8w+X4HxuW/BvTkN339n4o9fXWyZGpYUFUsylYJVTWdumBaF9BRQoCzL033g1alq5MmiDQ8e59H1WB2uvFBhNueC75ggVmtQk2So1iSQFYU8qJDEdZaw3W7TtCgEvukDq0IpQge7moigaZN3eoBRCzDGYJoGK9U0TeIac1ImNJtNODw8BN/3fwfulvcY0PZ85Lge2A5JR74ZS6SoLCFV79qq28ACdLtUDChJ0jGwXC4zoOu6iIg6e7tGku2UdqFycACqqpKya7CzU4LSbhlEUQRN02gy1Ol0oFqtngykq9gD0gR0MnWMu0f9cKzTCfudPyT8FXiWRr7z2YF0Uc6g8wHDFKel+w/8d4typL/dNri/D1mCbkg7ShQet146fNrRe0UHyaFvUihxRIAoQB1U+SEjy/ZQFwNqBwFSVA2RY4jIb4zMaSLCbIbAaB8oCMLbk8p59Bng9nuAOwsAD5ePx7snzCV/pPk+MB6PX8tkMvMbGxvTqVSaT6VS/JfNLT66mOUjC1QZfupDhs/m8nw+n+fTW8QLBb5ARPrTxWJxPplM3mAwUt4gMaoLRENEF8+pofDZQcr6CdGjaSqAbDNVAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"start Node.js profile\"\n        title=\"start Node.js profile\"\n        src=\"/static/0dca8eb2530d423ec59efcea05001bb9/a6d36/start-profile.png\"\n        srcset=\"/static/0dca8eb2530d423ec59efcea05001bb9/222b7/start-profile.png 163w,\n/static/0dca8eb2530d423ec59efcea05001bb9/ff46a/start-profile.png 325w,\n/static/0dca8eb2530d423ec59efcea05001bb9/a6d36/start-profile.png 650w,\n/static/0dca8eb2530d423ec59efcea05001bb9/e548f/start-profile.png 975w,\n/static/0dca8eb2530d423ec59efcea05001bb9/3c492/start-profile.png 1300w,\n/static/0dca8eb2530d423ec59efcea05001bb9/7be33/start-profile.png 1558w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Then, we need to send a request to our server. You can do it in whatever ways:\nthe browser, Postman, curl…  I am just going to use curl here:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> localhost:3001/coin-prices</code></pre></div>\n<p>After we get our response back, we stop the profiling by hitting the record\nbutton again. Then, a profile will have been captured. To see a visualization of the\ncall stack, select the \"Chart\" option from the top selector.  </p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 650px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3da02846af5a68ea06bce365754e61f8/7be33/profile-chart.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 111.65644171779141%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAABYlAAAWJQFJUiTwAAADGUlEQVQ4y62Uz08TQRTHIcqFM8u/pScOevBs/B88eJOIRomBNBJEjQk3gkAFClRAW8QWRZFSoLS1pWW3u+3szv6c3Xm+3dKlEIigvuSbmZ3J++z7MTMdHWipu33dI2/v9U7Eoj1LszFhOf5BiE1PC4nkmvB8aFjoH3gsPLh/X3gViQjxWEyYmZwU3k9NCdF374SF2dmexMpK73w02t3RssP05/4jMQtiTWoQWaayJNK6otC6KNJyPk/3Mxmaz+VosVikBNdJvR5KqdUaGiHwq1B4EgI3Nr+/0KkJpVKJ54oVOCjXoLa5AeUvSVD3d0DO/ADycxOq+RwQjYKh60ApBR1HWZa567qwu7v7KgSm0xsRqlOQajVHlGTeoCavf13n6maKG9ktXvuW4vqPDe5qhCtE5YqicMe2uWEY/EiUHEDb29sbDYG7ma0IpQYQ5Yi5JgFuq+BYFMBlAMwBz7KA2YFfYJ7ntc+ZP5bL5Zch8NZAKjK0IELfYIndeFqBm89EePNJCxwc1wOGAMNkYBgmyghhjDFfARDLdQJ8OP49sritweB8nT2aUeBRtA7RLxUoFfOYyj7k83k4kiWoVKuwncnAwcEBFIpFyOAc95jjOLC+vn4CrBT3Is1wVAYuRoayDQKEqGCaJtiWDdh7aBgN0AwKGjZGVdWgOZZlBRGeAmZ2sgGw3lBZg2j+GKTXbpqjg8F0cLkLZywAptPpE2A22wTiX5mmac2/Y60456E02wDbdbCeLnCPt+8FwFQq9Wegby1H6pjgMOw2NrW1drz/d0ATU2bMxJP0n4C604R5eCvOA16qhk2HJpT66eKZ9ML6wV9GeByl5VjgcQS2mnHmphQKhcsBW2mb2OH2rp+9etVq9apAG/y4LgJWKpULgfw8oM3sU01qbV0EHPYXCSGmD8WR4VvH/IL7Dr4MZofzduFbGFypw8PDkRCYy+Vewz+aJEnjIXBiYuL26urq+OLi4mg8Hh9bWloaW15eHltbWwuUTCbHkomPp75b80QiMYpHZnxubu5OAMP0OnHwdQ3Vhbp+RXUd+3b6rN+TQG2DZvuHrQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Node.js profile chart view\"\n        title=\"Node.js profile chart view\"\n        src=\"/static/3da02846af5a68ea06bce365754e61f8/a6d36/profile-chart.png\"\n        srcset=\"/static/3da02846af5a68ea06bce365754e61f8/222b7/profile-chart.png 163w,\n/static/3da02846af5a68ea06bce365754e61f8/ff46a/profile-chart.png 325w,\n/static/3da02846af5a68ea06bce365754e61f8/a6d36/profile-chart.png 650w,\n/static/3da02846af5a68ea06bce365754e61f8/e548f/profile-chart.png 975w,\n/static/3da02846af5a68ea06bce365754e61f8/3c492/profile-chart.png 1300w,\n/static/3da02846af5a68ea06bce365754e61f8/7be33/profile-chart.png 1558w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>They way you interpret this is the same as how you would interpret the timeline\nfor profiling our web application.  Notice how our program exhibit peaks in the\ncall stack! This is indicative of the performance issue with our API. Our\nrequest took almost 2000 ms to finish (the distance from the first peak to\nthe last peak), which is pretty slow for a simple endpoint.</p>\n<p>If we zoom into one of the peak, we realize that our server is handling one of our API calls! </p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 650px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cf4bbf6659ae2727cf315024d000baaa/d3deb/callstack.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 63.80368098159509%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAACEklEQVQ4y42Sb0/aUBTG+f5fYW+WvVmyvVicydzMUOSvY2qFQqH0L23BQkvBTucE299uW+YMmmU3eXp+55x7n9zc01IUx1TbFRRTxg1tVLtPX+9gzwx0b4g8kjCnGpav09MuGTkK47mJYnTFmW7OmjtA1iTcwKF0/TPmY7fOoXVBdTbkdGXSWho0F3oeszzjZqQXvajoPd13uhR7BHeuheH9+o6jszK1TgXZ6zCYKyh+n8FMyaXM+rny+h/O68ojZ72+38NcGJSSNGUs17l1L9mI5nois3Y7bLzuo9ZP2X2JZTb5+RGlh2jOcfkV1dZrpM5bWs4+df8LjavPNPP4l5vbelbb5dr0E5dhQxh6Fsr7dyh7+7jlA3x1gOM4uLaNZ49FHD+yt2V3l8djHMvC96aUIKV5MUKWDVS5gaadEwQaoXiPINSfK9BfrM8DlSgMM0OQwin6zYrBUKJ++Ab1bJ+ZUSGwTkQ8LmQW8p/kvn6Eb54QmDVmozLRwqYkZkJ2S7Lh/Ig57ZX51vuK3KtiexJXYoJXYpp53OEgGBC459iTFtakQRz7mWGaeZEWH4aGhqqOsBWLieqxcqKtllsVfJ2xvxI/vMfBeZu9eo1FvCoM8zvmxoIfRJLw3ys73TNnfKh85+bu9rlhliVpQpIkpEmaK+dtf5ezFa1iau22yDcv3PAf/Ky3Ndz8umchyaQPCb8BZuO6vKgjNjsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Call stack showing calls to getCoinPrice\"\n        title=\"Call stack showing calls to getCoinPrice\"\n        src=\"/static/cf4bbf6659ae2727cf315024d000baaa/a6d36/callstack.png\"\n        srcset=\"/static/cf4bbf6659ae2727cf315024d000baaa/222b7/callstack.png 163w,\n/static/cf4bbf6659ae2727cf315024d000baaa/ff46a/callstack.png 325w,\n/static/cf4bbf6659ae2727cf315024d000baaa/a6d36/callstack.png 650w,\n/static/cf4bbf6659ae2727cf315024d000baaa/e548f/callstack.png 975w,\n/static/cf4bbf6659ae2727cf315024d000baaa/3c492/callstack.png 1300w,\n/static/cf4bbf6659ae2727cf315024d000baaa/d3deb/callstack.png 1758w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<blockquote>\n<p>Tip: you can use <kbd>Ctrl</kbd>+<kbd>F</kbd> or <kbd>⌘F</kbd>\nto search for a named function in the call stack.</p>\n</blockquote>\n<p>The culprit here is the serial handling of our request to get the prices of the cryptocurrencies. The <code class=\"language-text\">for</code> loop <code class=\"language-text\">await</code>s for one API call to be done before making the next one! </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> coinId <span class=\"token keyword\">of</span> listOfCoins<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    prices<span class=\"token punctuation\">[</span>coinId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getCoinPrice</span><span class=\"token punctuation\">(</span>coinId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n    <span class=\"token comment\">// wait for it to be done, before we can start the next one</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This is a waste of time. We could have started all the request at once, and\ncollect the result all together. </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> prices <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>listOfCoins<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token parameter\">id</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    prices<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getCoinPrice</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Let me explain the code. For each of the coin ID, we call an <code class=\"language-text\">async</code> function\non it. The function takes the coin ID and get its price to put it in the\n<code class=\"language-text\">prices</code> object. You might ask, isn't this still calling <code class=\"language-text\">await</code> in a loop?\nNot exactly. Imagine how <code class=\"language-text\">map</code> calls the function:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// imaginary `map` function</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">func</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> results <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> item <span class=\"token keyword\">of</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        results<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token function\">func</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> results<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">map</code> does not <code class=\"language-text\">await</code> for the given <code class=\"language-text\">func</code>. Remember that <code class=\"language-text\">async</code> function\nreturns a <code class=\"language-text\">Promise</code>. <code class=\"language-text\">map</code> iterates through the list of coin IDs, kicks off one\n<code class=\"language-text\">async</code> function call for each coin, and collects each <code class=\"language-text\">Promise</code> returned from the\n<code class=\"language-text\">async</code> function. Therefore, the output of <code class=\"language-text\">map</code> is an array of <code class=\"language-text\">Promise</code>s.\nUsing <code class=\"language-text\">Promise.all</code>, we turn the array of <code class=\"language-text\">Promise</code>s into one single <code class=\"language-text\">Promise</code>,\nwhich only resolves when all the <code class=\"language-text\">Promise</code>s in the array are resolved, i.e.,\nall the API calls are finished. </p>\n<p>With the new piece of code, we are making the requests for the prices all at\nonce so they run in parallel. </p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 650px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/362c9779606ce8f310f13275ecbd0a43/09262/comparison.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.46625766871166%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA2klEQVQoz4WSaa7DIAyEuf9l8iPKGXKVKFKUfV9cfa5A1I/XWhoZjDEzNk4ie54n+Pu+FfbcI86PzRGcpkm2bQsJ53lK3/fSdZ2s66oglipu11owyzIpy/IPC//YMAwyjqOCfczM5juCKXnWrusKbHkAoCop2RtFkQYoAFgfx/ERW5ZF5nlW7/PJ2ff9zdDS5xLSAOt4SMAOD++LOgJcpLqXzUHbttI0TZCVmmjKHAzyPJeiKFSC7xdTrutapaWa/x/CUGAYS+HLVFWlTO0//cowlRT/K9uzX/YCxI0TMD2btuAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"comparison between unoptimized and the new\"\n        title=\"comparison between unoptimized and the new\"\n        src=\"/static/362c9779606ce8f310f13275ecbd0a43/a6d36/comparison.png\"\n        srcset=\"/static/362c9779606ce8f310f13275ecbd0a43/222b7/comparison.png 163w,\n/static/362c9779606ce8f310f13275ecbd0a43/ff46a/comparison.png 325w,\n/static/362c9779606ce8f310f13275ecbd0a43/a6d36/comparison.png 650w,\n/static/362c9779606ce8f310f13275ecbd0a43/e548f/comparison.png 975w,\n/static/362c9779606ce8f310f13275ecbd0a43/3c492/comparison.png 1300w,\n/static/362c9779606ce8f310f13275ecbd0a43/09262/comparison.png 1896w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>After the optimization, we take another profile snapshot. </p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 650px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a6de03300e12117d46b26346c7e28d3f/b97f6/optimized-callstack.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.47239263803681%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAApUlEQVQY041QywrDIBD0/78vhZBDSuqjoSRYaKr1sU51qVDopQPruM6wjoppmnCRCua6wnsPIkLOuXL+MMHaO6TSeBwH9ykl1ho3jOOIYThhnmcIYwwLMUY2dTjfeuJ9G9L0PqCjlMK8bRuWZYGUEmJd1x8DUYG6RcRU8A+stVBKQWsN0ZZ2cy+qKUNIOBuPpwtwzmPf7/U7XvU88Ct6sb+m/074Bt2jNgaqAYxmAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Call stack after optimization\"\n        title=\"Call stack after optimization\"\n        src=\"/static/a6de03300e12117d46b26346c7e28d3f/a6d36/optimized-callstack.png\"\n        srcset=\"/static/a6de03300e12117d46b26346c7e28d3f/222b7/optimized-callstack.png 163w,\n/static/a6de03300e12117d46b26346c7e28d3f/ff46a/optimized-callstack.png 325w,\n/static/a6de03300e12117d46b26346c7e28d3f/a6d36/optimized-callstack.png 650w,\n/static/a6de03300e12117d46b26346c7e28d3f/b97f6/optimized-callstack.png 958w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>The distance between the first peak and the last peak dropped to under 400 ms. That's a 5× speed-up!</p>\n<p>If we take a close look at the first peak of the call stack, we can see that\nthere are multiple request being sent back to back, meaning\nthat the requests are fired together. </p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 650px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/26730b7bde92a8bfdbf0751763d59350/efa1a/mult-request.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.104294478527606%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABt0lEQVQozzWQW3OaUBSF+f+/oA8+9imTTjuTNGMf0nFEB4y3WBUvKJcDJjE10oCKgPAVUPfMOmedvda+zJFsU7ByVzjCwXVdhC0wTBfTsBBClPkSTq47Z17kXcc91ziXd15beCSjs2Va2zCrbbGVkEXTx1ZDlnKA2dxjKnss5YDR3JX8qlnKjmUzQKhHFnW/rPU2eyRPN5jeP+J1pvgFGks2sob3pOF352zrY9bygCDnXl1j3fhz9rVe+GjO+VBHBP0FfntCtvWQdtaIXqfKoH/P6rVP/PzEYqzSUm4RVoNN44Fx/5F++zt/5Z+MhnV66i12W2UuV1GVb9imzItRI3Z1JN7z/2r9YlCt8G/WgpXg6C6Z1G6Y/f4K+jPrkUL37gvptMv7uMXwocJhZWIM26h3FQz5hnX7B9GbhZQkRwyhMxJDNp5LGXFMsPew33SyU4zzamM6E07hjjSK0N0hUbznEH5iuBqapaGbPcL4gJRmGWmS4Scn4pwXUZxpjiAfVkQSnyik9KL70Y5jEp6H58ZNHDHbmhTLSVluysoW+XltmGUXpJfc2XPNXyPN0vL+zDf3Qr/k/wHeiEsQBf+UkgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Multiple request being made, shown in the call stack\"\n        title=\"Multiple request being made, shown in the call stack\"\n        src=\"/static/26730b7bde92a8bfdbf0751763d59350/a6d36/mult-request.png\"\n        srcset=\"/static/26730b7bde92a8bfdbf0751763d59350/222b7/mult-request.png 163w,\n/static/26730b7bde92a8bfdbf0751763d59350/ff46a/mult-request.png 325w,\n/static/26730b7bde92a8bfdbf0751763d59350/a6d36/mult-request.png 650w,\n/static/26730b7bde92a8bfdbf0751763d59350/e548f/mult-request.png 975w,\n/static/26730b7bde92a8bfdbf0751763d59350/3c492/mult-request.png 1300w,\n/static/26730b7bde92a8bfdbf0751763d59350/efa1a/mult-request.png 2040w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>In the real world, optimization is not just looking for loops with <code class=\"language-text\">await</code> in\nthem. It is more complex than this. However, knowing how to profile and seeing\nhow CPUs are consumed in your application definitely helps you in optimizing\nthe application. </p>\n<p>The complete implementation of the optimized program can be found in the following repository: </p>\n<blockquote>\n<p><a href=\"https://github.com/uclaacm/js-chats-s21/tree/main/node-profile\">https://github.com/uclaacm/js-chats-s21/tree/main/node-profile</a></p>\n</blockquote>","frontmatter":{"date":"2021-04-11T00:00:00.000Z","title":"Node.js Profiling","subtitle":"JavaScript Chats Hack Session 2 Spring 2021","author":null}}},"pageContext":{"slug":"/posts/spring2021/js-chats-2/"}}}