{"componentChunkName":"component---src-components-post-post-template-js","path":"/posts/fall2019/js-chats-5/","webpackCompilationHash":"6875eacd0943aa120056","result":{"data":{"markdownRemark":{"html":"<ul>\n<li><a href=\"#an-overview-of-multi-threading\">An overview of multi-threading</a></li>\n<li><a href=\"#different-kinds-of-multi-threading\">Different kinds of multi-threading</a></li>\n<li><a href=\"#creating-a-web-worker\">Creating a Web worker</a></li>\n<li>\n<p><a href=\"#inter-thread-communication\">Inter-thread communication</a></p>\n<ul>\n<li><a href=\"#structured-serializationdeserialization\">Structured serialization/deserialization</a></li>\n<li><a href=\"#advanced-structured-cloning-with-transfer\">(Advanced) Structured “cloning” with… transfer?</a></li>\n<li><a href=\"#conclusion\">Conclusion</a></li>\n</ul>\n</li>\n<li><a href=\"#when-should-we-use-multi-threading\">When should we use multi-threading?</a></li>\n<li><a href=\"#libraries-for-multi-threading\">Libraries for multi-threading</a></li>\n</ul>\n<h2 id=\"an-overview-of-multi-threading\"><a href=\"#an-overview-of-multi-threading\" aria-label=\"an overview of multi threading permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>An overview of multi-threading</h2>\n<p>For the past decade, computer-makers have realized that there are physical\nlimits to the performance of a CPU.\nAt some point, newer CPUs can no longer process each instruction much faster\nthan the previous generation of CPUs – and it is clear that we are nearing\nthat point.\nThe key to increasing computer performance then rests in the ability to\nprocess multiple instructions simultaneously by packing more “cores” onto\neach individual CPU, rather than making each core faster.</p>\n<p>Unfortunately, programs designed to run on a single thread (or CPU core) are\nunable to automatically take advantage of the increasing number of cores on a\nsystem.\nOne of the reasons for this is the problem of synchronization.\nSingle-thread programs assume a <em>linear order of execution</em>; to wit, with the\nfollowing piece of JavaScript code, we expect “Alonso” to be printed before\n“Bellinger.”</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Alonso'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Bellinger'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Now consider the case where this program runs in a <em>multi-threaded</em> fashion,\nwith each of these statements running on a different core.\nThere then would be no guarantee to the order of output: the first statement\ncould finish later than the second, or it could start later but finish\nsooner, or it could even run just as expected, starting and finishing before\nthe second statement runs.\nTo recover the single-threaded behavior, we’d have to make the two CPU cores\nsynchronize with each other before and after statement – which essentially\ndefeats the purpose of using multiple cores.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 650px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9f84bbe71c8e1ce64e2303810469fcca/18b79/multi-threading.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.61244019138756%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAAB9UlEQVQoz4VTTYvUQBDNL/YvePLkSdHDwh4E8SB4kD2IIIiyFz9WZll3mIVMMsl8KXGSyeS7O5086yU7caMHGzqVVHVVvfe6YrVtCy7auq5Rmxamd9GL4U3ix7N/r7s1rONH0zRYLZdYujcIf/riUMgMkNQtCjMuzMbGGFRVNSrGZfGhtUZelKhVhuriAdT5PaTuGzxZAPe/p3jhSUzOsJDWNdI0xWq1wmQywWw2Q57nfxAeX9gxyzKkhUZaCnVpqARZKVs17YgybVmWiKKo22Q3otzTMFj7C4RfThF/egwEFz3HRni3zZBUFAUOh0OHcjqdwrZtJEkyRqiUEtgFVK3w8fNzvH3/CFc3HwR1H+OmXrSkzaJkFIYhHMfBfD7v2A0adtpIwu6Q4ZkHPHWAdz8MVFkgE31YrJsA2SxKukRMpJ7nYbfbDZdm3dVlLUJnUYxinyAKfmG5XsNdeKLTfkhgIaLhRbAQdxzHCIKga2AdDxkKb0roxRmU/RImuISRRJOEUFki8UaaNsPlMIfUiZaW9NmkHxuhkYmGVb5HfnWC6ttDzO1zvN4YvFokuI6EoqKGukvmzdJydFzXHcZmpKGSBC03rW8DM9H41Clw4pT4Goq36WewuZWIOZvNBr7vY7vdDsitf36n1siU1BRi7Mb/F2v9BgMom/NEECdBAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Illustration of different scenarios of the execution of the above code\nfragment\"\n        title=\"Illustration of different scenarios of the execution of the above code\nfragment\"\n        src=\"/static/9f84bbe71c8e1ce64e2303810469fcca/dbb61/multi-threading.png\"\n        srcset=\"/static/9f84bbe71c8e1ce64e2303810469fcca/19bd1/multi-threading.png 163w,\n/static/9f84bbe71c8e1ce64e2303810469fcca/d3bcb/multi-threading.png 325w,\n/static/9f84bbe71c8e1ce64e2303810469fcca/dbb61/multi-threading.png 650w,\n/static/9f84bbe71c8e1ce64e2303810469fcca/6b691/multi-threading.png 975w,\n/static/9f84bbe71c8e1ce64e2303810469fcca/91670/multi-threading.png 1300w,\n/static/9f84bbe71c8e1ce64e2303810469fcca/18b79/multi-threading.png 2926w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Even though multi-threading doesn’t work too well with this application, as\nwe will soon see, there are many JavaScript programs where multi-threading is\nable to provide a huge boost in performance.\nIt does however take a human – not a machine – to identify if and how\nmulti-threading could improve the performance.</p>\n<h2 id=\"different-kinds-of-multi-threading\"><a href=\"#different-kinds-of-multi-threading\" aria-label=\"different kinds of multi threading permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Different kinds of multi-threading</h2>\n<p>Different programming languages support multi-threading differently.</p>\n<p>Many traditional languages like C, C++, and Java all support <strong>shared-memory\nmulti-threading</strong>.\nIn this régime, two threads belonging to the same program have access to the\nsame variables.\nA thread can modify variables and other in-memory objects that belong to\nanother thread.</p>\n<p>On the other hand, JavaScript (until very recently) does not support\nshared-memory multi-threading at all.\nIn JavaScript traditionally, for two threads to communicate with each other,\nthey have to explicitly send “messages” to the other thread.\nAny objects that are sent through the communication channel are copied, so\nthere is no way for two JavaScript threads to read the memory of the other\nthread.</p>\n<blockquote>\n<p>Question: What are some pros and cons for each approach of multi-threading?\nWhy do you think JavaScript doesn’t use shared-memory multi-threading?</p>\n<details><summary>Here is an answer.</summary>\n<p>Shared-memory multi-threading is easy to get started with. You pretty much\ndo the same things as regular single-threaded programs.\nThere is very little overhead when using single-threaded programs: no need\nto clone objects like one does in JavaScript, etc.</p>\n<p>However, shared-memory multi-threading requires explicit synchronization\n(spinlocks and mutexes) in order to avoid race conditions.\nEven with locking, it’s easy to introduce bugs into a program.</p>\n<p>From the very beginning, JavaScript is designed to be robust.\nThere are no undefined behaviors in the language, unlike C and C++.\nShared-memory multi-threading introduces the possibility to do Very Bad\nThings™ to the program, and so browsers decided not to take that path when\nintroducing the feature.</p>\n</details>\n</blockquote>\n<h2 id=\"creating-a-web-worker\"><a href=\"#creating-a-web-worker\" aria-label=\"creating a web worker permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Creating a Web worker</h2>\n<p>Enough talk. Let’s spawn a thread in JavaScript.\nWe will use the <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API\">Web Workers API</a> that exists in web\nbrowsers, though Node.js provides a very similar API through its\n<a href=\"https://nodejs.org/api/worker_threads.html\"><code class=\"language-text\">worker_threads</code></a> module.</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token comment\">&lt;!-- index.html --></span>\n<span class=\"token doctype\">&lt;!doctype html></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\">\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Before spawning a worker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> worker <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Worker</span><span class=\"token punctuation\">(</span><span class=\"token string\">'worker.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'After spawning a worker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// worker.js</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'We are in a worker!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Visiting <code class=\"language-text\">index.html</code> would result in the following being printed in the\nDevTools console:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Before spawning a worker\nAfter spawning a worker\nWe are in a worker!</code></pre></div>\n<p>When we get into the DevTools in the Sources tab, we see that there is now a\n“Threads” section there is now a worker.\nFrom now on, we will call the <code class=\"language-text\">index.html</code> thread the <strong>main thread</strong>, and\nthe worker… the <strong>worker thread</strong>.</p>\n<p>Recall from <a href=\"../js-chats-2/\">session 2</a> that every JavaScript environment in\nthe browser has an event loop.\nIf a task runs for too long, it could make the whole page unresponsive.\nIndeed, if we were to put an infinite loop in the <code class=\"language-text\">&lt;script&gt;</code> element in the\nHTML file, we do indeed see that the page stopped responding.\nThe task on the main thread has <em>blocked the event loop</em>.</p>\n<div class=\"gatsby-highlight\" data-language=\"diff\"><pre class=\"language-diff\"><code class=\"language-diff\"><span class=\"token unchanged\"> &lt;body>\n</span><span class=\"token inserted-sign inserted\">+  &lt;button>Test&lt;/button>\n</span><span class=\"token unchanged\">   &lt;script>\n   console.log('Before spawning a worker');\n   const worker = new Worker('worker.js');\n   console.log('After spawning a worker');\n</span><span class=\"token inserted-sign inserted\">+\n+  while (true) continue;\n</span><span class=\"token unchanged\">   &lt;/script>\n &lt;/body></span></code></pre></div>\n<p>However, if we put the loop in <code class=\"language-text\">worker.js</code> instead, the page would still\nresponsive.\nThis tells us that <strong>each worker thread gets its own event loop</strong>.</p>\n<h2 id=\"inter-thread-communication\"><a href=\"#inter-thread-communication\" aria-label=\"inter thread communication permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Inter-thread communication</h2>\n<p>As mentioned earlier, to communicate between threads, the Web Workers API\ngenerally requires the use of message-passing.\nHere’s an example.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// part of index.html</span>\n<span class=\"token keyword\">const</span> worker <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Worker</span><span class=\"token punctuation\">(</span><span class=\"token string\">'worker.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// When a message is received from the worker thread…</span>\nworker<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onmessage</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">msg</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Received message from the worker:'</span><span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// worker.js</span>\n<span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Send a message to the main thread.</span>\n  <span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hello world!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>We observe that every 500 ms (or every half-second), the text\n“Received message from the worker: hello world!”\ngets printed to the JavaScript console.\nHere, we are sending messages from the worker thread to the main thread.</p>\n<p>We can send objects too, not just strings:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// worker.js</span>\n<span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    timestamp<span class=\"token punctuation\">:</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    status<span class=\"token punctuation\">:</span> <span class=\"token string\">'Healthy'</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>And now we see that the object gets printed to the console through the\n<code class=\"language-text\">worker.onmessage</code> function.</p>\n<p>Similarly, we can pass messages from the main thread to the worker thread, by\ncalling <code class=\"language-text\">worker.postMessage()</code> from the main thread and setting the\n<code class=\"language-text\">self.onmessage</code> event handler in the worker.</p>\n<h3 id=\"structured-serializationdeserialization\"><a href=\"#structured-serializationdeserialization\" aria-label=\"structured serializationdeserialization permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Structured serialization/deserialization</h3>\n<p>Let’s now try something a bit trickier. Let’s modify the object sent from the\nworker thread, in the main thread.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// part of index.html</span>\n<span class=\"token keyword\">const</span> worker <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Worker</span><span class=\"token punctuation\">(</span><span class=\"token string\">'worker.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nworker<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onmessage</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">msg</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> obj <span class=\"token operator\">=</span> msg<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">;</span>\n  obj<span class=\"token punctuation\">.</span>count <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// worker.js</span>\n<span class=\"token keyword\">const</span> obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> count<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>We expect the output to be an ascending sequence of integers with a new line\nprinted every half-second, starting with 0.\nHowever, what we actually observe is that a 0 is printed every half-second.</p>\n<blockquote>\n<p>Question: Why is this the case? (Hint: this has to do with the fact that\nJavaScript does not use shared-memory multi-threading.)</p>\n</blockquote>\n<p>Recall that earlier we mentioned that JavaScript in general does not allow\nshared-memory multi-threading.\nWhenever an object is sent from the worker to the main thread (or vice versa)\nas a message, the object is <em>cloned</em> (copied).</p>\n<p>In the HTML Standard and also in a variety of other sources, the cloning\nalgorithm has a special name:\n“<a href=\"https://html.spec.whatwg.org/multipage/structured-data.html#safe-passing-of-structured-data\">structured serialization/deserialization</a>,” or\n“<a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm\">structured cloning</a>.”\nUnlike some other methods of cloning objects in JavaScript, structured\nserialization/deserialization has some special properties that make them\nextra “good”:</p>\n<ul>\n<li><strong>Deep cloning</strong>: not just the message object itself is cloned, but also\nall of its properties. <code class=\"language-text\">Object.assign()</code> and the object spread syntax <code class=\"language-text\">{\n...obj }</code> only create shallow clones.</li>\n<li><strong>Deals with cycles</strong>: the commonly-used deep-cloning idiom of\n<code class=\"language-text\">JSON.parse(JSON.stringify())</code> does not work if there is a cycle in the\nproperty graph (e.g., if <code class=\"language-text\">obj.a === obj</code>). Structured cloning works just\nfine with that.</li>\n<li><strong>Preserves (most) built-in objects</strong>: <code class=\"language-text\">JSON.parse(JSON.stringify())</code> does\nnot preserve built-in objects like <code class=\"language-text\">Date</code> objects. Structured cloning works\njust fine.</li>\n</ul>\n<p>There still remain certain data types that cannot be cloned, like functions\nand <code class=\"language-text\">Error</code> objects. But that doesn’t seem too bad.</p>\n<h3 id=\"advanced-structured-cloning-with-transfer\"><a href=\"#advanced-structured-cloning-with-transfer\" aria-label=\"advanced structured cloning with transfer permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>(Advanced) Structured “cloning” with… transfer?</h3>\n<p>Having to copy things all the time seem quite wasteful.\nWe must be able to think of something better that still avoids the\nsynchronization problem, right?</p>\n<p>With certain objects like <code class=\"language-text\">ArrayBuffer</code> objects (that just represent\nsequences of bytes), instead of copying it we could <em>transfer</em> the bytes from\none thread to another.\nLet’s see it.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// main thread</span>\n<span class=\"token keyword\">const</span> arr <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nworker<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>arr<span class=\"token punctuation\">.</span>buffer<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'After transfer:'</span><span class=\"token punctuation\">,</span> arr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// worker thread</span>\nself<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onmessage</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">msg</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'In worker:'</span><span class=\"token punctuation\">,</span> msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Here, no copying of the <code class=\"language-text\">Uint8Array</code> object is done (fast!).\nBut we see that after the transfer <code class=\"language-text\">arr</code> becomes empty.\nThis maintains the invariant (guarantee) that no two distinct JavaScript\nthreads may access the same object at the same time.</p>\n<h3 id=\"conclusion\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h3>\n<p>Altogether, the process of sending a message could be summarized by the\nfollowing comic:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 650px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/109a05f663ee6871965938a33a662d50/74e9f/postMessage.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 73.80315194766577%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAACUUlEQVQ4y2VTiY6rMAzk//9t9wNW2rbqliOFACFADhLm2ab0XZGsCCeMZ8ZOMU0TQgiQtR/bz88Pns8nzrVtG8qyhFsd0pbk/PPzE8MwwDuPoR8EY55nFPu+g8NnD5cctrShqRvMbob1Fj56LMsioY2G6hW891DNsZeqxK28YRxHKV4cxHaMaYQOGvMyo322MM5AeYXOdrCTlfwQByin5D7nUk7QXqML3VtNEWMUSXvekbcsSZbHjPZtFxuccyIPdMx3csrQWgvD8z/G4Ciu1yustTDGwM5WfGDA+/2Oqq6wrivY56+vL5HF51zg+/tbfOZzzp22iIdciQ0PLrypc16Y055SEtAzz4vBOZ9zxp9LPIxbRGta6ElL8ry4kR2yEzADcuGJvaNzVsXsOPj7LCaA3MmHeUBZJQAcIUR05NOyrASYxMOKrLhdLwTspEBP54pks5/ntAggz9CgB4mV/BHWpKRbMzpP52T6SvPWTAHl6LESocnQVMwRj8Ghd79lF03TCP1lXSTG0UjFZ0ujYybKrdKky+WCns5GkmypCXzHEMthNPI9v6Louk4YeopMlJVS+Pj4EBAuxGPVEjh3/fDRiWfcaRmbV9NO30XyQkNbVyWqx0PA67qWhtjJILwAuHoggBhIMt3nQgz47yqoBD2xDdXocO+pAWRH+1TU8RWV8ajtRrKdAA5LQNXTzK7x3VWexVPNe2xYqvMRIR7tZ9neBzjqdExHx/kHLqxnYsgvCEdXmSmPDu8CeMzp/tfQctXzwjkFJ4M9p9fr/3/x/78ANYaKOOmaGVUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Comic describing the innerworkings of postMessage\"\n        title=\"Comic describing the innerworkings of postMessage\"\n        src=\"/static/109a05f663ee6871965938a33a662d50/dbb61/postMessage.png\"\n        srcset=\"/static/109a05f663ee6871965938a33a662d50/19bd1/postMessage.png 163w,\n/static/109a05f663ee6871965938a33a662d50/d3bcb/postMessage.png 325w,\n/static/109a05f663ee6871965938a33a662d50/dbb61/postMessage.png 650w,\n/static/109a05f663ee6871965938a33a662d50/6b691/postMessage.png 975w,\n/static/109a05f663ee6871965938a33a662d50/91670/postMessage.png 1300w,\n/static/109a05f663ee6871965938a33a662d50/74e9f/postMessage.png 3363w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2 id=\"when-should-we-use-multi-threading\"><a href=\"#when-should-we-use-multi-threading\" aria-label=\"when should we use multi threading permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>When should we use multi-threading?</h2>\n<p>This is, of course, the million-dollar question.</p>\n<blockquote>\n<p>Question: Any ideas? What do we look for in an application for which\nmulti-threading may be beneficial?</p>\n</blockquote>\n<p>There are answers to this question that are programming language-agnostic,\nbut let’s focus on the JavaScript-specific reasons.</p>\n<p>Here are a few rules of thumb:</p>\n<ul>\n<li>Heavy computation that could take a while to finish should be moved to\nworker threads. We never want to block the main thread, as it’s tied to the\nUI responsiveness.</li>\n<li>Work that is relatively independent of the UI could be in workers.\nWe can only operate the UI from the main thread, and the communication\noverhead could be quite palpable if many DOM operations are being done.</li>\n</ul>\n<p>An example where Web Workers are used in concert with DOM APIs is\n<a href=\"https://mozilla.github.io/pdf.js/\">PDF.js</a>, a PDF viewer written by Mozilla in JavaScript and the\ndefault PDF viewer in Firefox.\nThe hard-core file parsing and number crunching routines are all done on a\nworker thread.\nThe results are then posted to the main thread, where they are rendered into\nDOM elements.</p>\n<h2 id=\"libraries-for-multi-threading\"><a href=\"#libraries-for-multi-threading\" aria-label=\"libraries for multi threading permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Libraries for multi-threading</h2>\n<p>To help with the awkwardness of the <code class=\"language-text\">postMessage()</code> APIs, Google has created\na library called <a href=\"https://github.com/GoogleChromeLabs/comlink\">Comlink</a> that makes communicating with a worker as\neasy as calling an asynchronous function.</p>\n<p>Google has also experimented with other worker-based technologies, like\n<a href=\"https://github.com/ampproject/worker-dom\">worker-dom</a>, which provides a DOM\nfor web workers to manipulate and then batches the DOM mutations to be sent\nto the main thread at once.</p>","frontmatter":{"date":"2019-11-12T00:00:00.000Z","title":"Multi-threading in JavaScript: Worker Threads","subtitle":"JavaScript Chats with ACM Hack Session 5"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/posts/fall2019/js-chats-5/"}}}